<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Onekey - é¦–æ¬¡ä½¿ç”¨å‘å¯¼</title>

    <!-- Material Design 3 -->
    <link
      href="https://cdn.jsdmirror.com/gh/ikun0014/font@main/style.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/style.css" />
  </head>

  <body>
    <div class="oobe-container">
      <!-- é¡¶éƒ¨åº”ç”¨æ  -->
      <div class="oobe-card">
        <div class="oobe-header">
          <button
            type="button"
            class="theme-toggle"
            id="themeToggle"
            title="åˆ‡æ¢ä¸»é¢˜"
          >
            <span class="material-icons">light_mode</span>
          </button>
          <div class="oobe-logo">
            <span class="material-icons" style="font-size: inherit"
              >extension</span
            >
          </div>
          <h1 class="oobe-title">æ¬¢è¿ä½¿ç”¨ Onekey</h1>
          <p class="oobe-subtitle">ä¸€é”®è§£é”ï¼Œç•…äº«æ¸¸æˆä½“éªŒ</p>
        </div>

        <div class="oobe-content">
          <div class="step-indicator">
            <div class="step-dot active" data-step="0"></div>
            <div class="step-dot" data-step="1"></div>
            <div class="step-dot" data-step="2"></div>
          </div>

          <!-- æ­¥éª¤ 1: æ¬¢è¿ -->
          <div class="oobe-step active" data-step="0">
            <div class="welcome-text">
              <h3>ğŸ® æ¬¢è¿æ¥åˆ° Onekey ä¸–ç•Œ</h3>
              <p>
                Onekey æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ Steam
                æ¸¸æˆè§£é”å·¥å…·ï¼Œå¸®åŠ©æ‚¨è½»æ¾ç®¡ç†å’Œè§£é”æ¸¸æˆã€‚
              </p>
              <p>åœ¨å¼€å§‹ä½¿ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦éªŒè¯æ‚¨çš„æˆæƒå¡å¯†ã€‚</p>
              <p><strong>ç‰¹ç‚¹ï¼š</strong></p>
              <p>â€¢ æ”¯æŒ SteamTools å’Œ GreenLuma ä¸¤ç§è§£é”æ–¹å¼</p>
              <p>â€¢ ç›´è§‚çš„ Web ç•Œé¢ï¼Œæ“ä½œç®€å•</p>
              <p>â€¢ å®æ—¶æ—¥å¿—æ˜¾ç¤ºï¼Œè¿‡ç¨‹é€æ˜</p>
              <p>â€¢ å‰ç«¯ä»£ç å®Œå…¨å¼€æº, ç»å¯¹ä¸ç›—å·/æŒ–çŸ¿</p>
              <a href="https://shop.ikunshare.com" target="_blank"
                >â€¢ ç‚¹æˆ‘è´­ä¹°å¡å¯†</a
              >
            </div>
          </div>

          <!-- æ­¥éª¤ 2: å¡å¯†éªŒè¯ -->
          <div class="oobe-step" data-step="1">
            <div class="welcome-text">
              <h3>ğŸ”‘ æ¿€æ´»æ‚¨çš„å¡å¯†</h3>
              <p>è¯·è¾“å…¥æ‚¨çš„æˆæƒå¡å¯†ä»¥æ¿€æ´» Onekey å·¥å…·ã€‚</p>
            </div>

            <div class="key-input-section">
              <div class="input-group">
                <label for="activationKey" class="input-label">æˆæƒå¡å¯†</label>
                <input
                  type="text"
                  id="activationKey"
                  class="text-field"
                  placeholder="è¯·è¾“å…¥æ‚¨çš„å¡å¯†"
                  autocomplete="off"
                />
                <div class="input-helper">
                  å¡å¯†æ ¼å¼ï¼š[PREFIX]_XXXXXXXX-XXXXXXXXXXXXXXXX
                </div>
              </div>

              <div class="key-status" id="keyStatus">
                <div class="status-header">
                  <span class="material-icons" id="statusIcon">info</span>
                  <span id="statusMessage">éªŒè¯ä¸­...</span>
                </div>
                <div class="key-info" id="keyInfo"></div>
              </div>
            </div>
          </div>

          <!-- æ­¥éª¤ 4: å®Œæˆ -->
          <div class="oobe-step" data-step="3">
            <div class="welcome-text">
              <h3>ğŸ‰ è®¾ç½®å®Œæˆ</h3>
              <p>æ­å–œï¼æ‚¨å·²æˆåŠŸæ¿€æ´» Onekey å·¥å…·ã€‚</p>
              <p>ç°åœ¨æ‚¨å¯ä»¥å¼€å§‹ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½äº†ã€‚</p>
              <div
                class="key-info"
                id="finalKeyInfo"
                style="margin-top: 24px"
              ></div>
            </div>
          </div>

          <div class="oobe-actions">
            <button
              type="button"
              id="prevBtn"
              class="btn btn-text"
              style="display: none"
            >
              <span class="material-icons">arrow_back</span>
              ä¸Šä¸€æ­¥
            </button>
            <button
              type="button"
              id="nextBtn"
              class="btn btn-primary btn-large"
            >
              <span class="material-icons">arrow_forward</span>
              ä¸‹ä¸€æ­¥
            </button>
            <button
              type="button"
              id="verifyBtn"
              class="btn btn-primary btn-large"
              style="display: none"
            >
              <span class="material-icons">verified</span>
              éªŒè¯å¡å¯†
            </button>
            <button
              type="button"
              id="finishBtn"
              class="btn btn-primary btn-large"
              style="display: none"
            >
              <span class="material-icons">check</span>
              å¼€å§‹ä½¿ç”¨
            </button>
          </div>
        </div>

        <div class="loading-overlay" id="loadingOverlay">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>

    <!-- æç¤ºæ¡† -->
    <div id="snackbar" class="snackbar">
      <div class="snackbar-content">
        <span id="snackbarMessage"></span>
        <button id="snackbarClose" class="snackbar-action">
          <span class="material-icons">close</span>
        </button>
      </div>
    </div>

    <script>
      class OOBEManager {
        constructor() {
          this.currentStep = 0;
          this.totalSteps = 3;
          this.keyData = null;

          this.initializeEventListeners();
          this.updateStepDisplay();
        }

        initializeEventListeners() {
          document.getElementById("nextBtn").addEventListener("click", () => {
            this.nextStep();
          });

          document.getElementById("prevBtn").addEventListener("click", () => {
            this.prevStep();
          });

          document.getElementById("verifyBtn").addEventListener("click", () => {
            this.verifyKey();
          });

          document.getElementById("finishBtn").addEventListener("click", () => {
            this.finishSetup();
          });

          document
            .getElementById("activationKey")
            .addEventListener("input", () => {
              this.resetKeyStatus();
            });

          document
            .getElementById("activationKey")
            .addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                this.verifyKey();
              }
            });

          document
            .getElementById("snackbarClose")
            .addEventListener("click", () => {
              this.hideSnackbar();
            });
        }

        nextStep() {
          if (this.currentStep < this.totalSteps - 1) {
            this.currentStep++;
            this.updateStepDisplay();
          }
        }

        prevStep() {
          if (this.currentStep > 0) {
            this.currentStep--;
            this.updateStepDisplay();
          }
        }

        updateStepDisplay() {
          document.querySelectorAll(".step-dot").forEach((dot, index) => {
            dot.classList.remove("active", "completed");
            if (index < this.currentStep) {
              dot.classList.add("completed");
            } else if (index === this.currentStep) {
              dot.classList.add("active");
            }
          });

          document.querySelectorAll(".oobe-step").forEach((step, index) => {
            step.classList.toggle("active", index === this.currentStep);
          });

          this.updateButtons();
        }

        updateButtons() {
          const prevBtn = document.getElementById("prevBtn");
          const nextBtn = document.getElementById("nextBtn");
          const verifyBtn = document.getElementById("verifyBtn");
          const finishBtn = document.getElementById("finishBtn");

          [prevBtn, nextBtn, verifyBtn, finishBtn].forEach((btn) => {
            btn.style.display = "none";
          });

          if (this.currentStep > 0) {
            prevBtn.style.display = "flex";
          }

          switch (this.currentStep) {
            case 0:
              nextBtn.style.display = "flex";
              break;
            case 1:
              verifyBtn.style.display = "flex";
              break;
            case 2:
              finishBtn.style.display = "flex";
              break;
          }
        }

        resetKeyStatus() {
          const keyStatus = document.getElementById("keyStatus");
          keyStatus.classList.remove("show", "success", "error");
        }

        async verifyKey() {
          const keyInput = document.getElementById("activationKey");
          const key = keyInput.value.trim();

          if (!key) {
            this.showSnackbar("è¯·è¾“å…¥å¡å¯†", "error");
            return;
          }

          if (!key.match(/^[A-Z0-9_-]+$/)) {
            this.showKeyStatus("error", "å¡å¯†æ ¼å¼ä¸æ­£ç¡®", "error");
            return;
          }

          this.showLoading(true);

          try {
            const response = await fetch("/api/getKeyInfo", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ key: key }),
            });

            const data = await response.json();

            if (data.key && data.info) {
              this.keyData = data.info;
              this.showKeyStatus("success", "å¡å¯†éªŒè¯æˆåŠŸï¼", "check_circle");
              this.displayKeyInfo(data.info);

              setTimeout(() => {
                this.nextStep();
                this.showFinalKeyInfo(data.info);
              }, 2000);
            } else {
              this.showKeyStatus(
                "error",
                data.message || "å¡å¯†ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ",
                "error",
              );
            }
          } catch (error) {
            this.showKeyStatus("error", "éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥", "error");
            console.error("Key verification error:", error);
          } finally {
            this.showLoading(false);
          }
        }

        showKeyStatus(type, message, icon) {
          const keyStatus = document.getElementById("keyStatus");
          const statusIcon = document.getElementById("statusIcon");
          const statusMessage = document.getElementById("statusMessage");

          statusIcon.textContent = icon;
          statusMessage.textContent = message;

          keyStatus.className = `key-status show ${type}`;
        }

        displayKeyInfo(keyInfo) {
          const keyInfoContainer = document.getElementById("keyInfo");
          const expiresAt = new Date(keyInfo.expiresAt);
          const isExpired = expiresAt < new Date();

          const typeNames = {
            day: "æ—¥å¡",
            week: "å‘¨å¡",
            month: "æœˆå¡",
            year: "å¹´å¡",
            permanent: "æ°¸ä¹…å¡",
          };

          keyInfoContainer.innerHTML = `
                    <div class="key-info-item">
                        <span class="material-icons">label</span>
                        <span>ç±»å‹ï¼š${typeNames[keyInfo.type] || keyInfo.type}</span>
                    </div>
                    <div class="key-info-item">
                        <span class="material-icons">schedule</span>
                        <span>åˆ°æœŸï¼š${expiresAt.toLocaleDateString()}</span>
                    </div>
                    <div class="key-info-item">
                        <span class="material-icons">analytics</span>
                        <span>ä½¿ç”¨æ¬¡æ•°ï¼š${keyInfo.usageCount}</span>
                    </div>
                    <div class="key-info-item">
                        <span class="material-icons">${keyInfo.isActive && !isExpired ? "check_circle" : "cancel"}</span>
                        <span>çŠ¶æ€ï¼š${keyInfo.isActive && !isExpired ? "æœ‰æ•ˆ" : "æ— æ•ˆ"}</span>
                    </div>
                `;
        }

        showFinalKeyInfo(keyInfo) {
          const finalKeyInfo = document.getElementById("finalKeyInfo");
          const expiresAt = new Date(keyInfo.expiresAt);

          const typeNames = {
            day: "æ—¥å¡",
            week: "å‘¨å¡",
            month: "æœˆå¡",
            year: "å¹´å¡",
            permanent: "æ°¸ä¹…å¡",
          };

          finalKeyInfo.innerHTML = `
                    <div class="key-info-item">
                        <span class="material-icons">verified_user</span>
                        <span><strong>å¡å¯†ç±»å‹ï¼š</strong>${typeNames[keyInfo.type] || keyInfo.type}</span>
                    </div>
                    <div class="key-info-item">
                        <span class="material-icons">event</span>
                        <span><strong>æœ‰æ•ˆæœŸè‡³ï¼š</strong>${expiresAt.toLocaleDateString()} ${expiresAt.toLocaleTimeString()}</span>
                    </div>
                `;
        }

        async finishSetup() {
          if (!this.keyData) {
            this.showSnackbar("å¡å¯†æ•°æ®ä¸¢å¤±ï¼Œè¯·é‡æ–°éªŒè¯", "error");
            this.currentStep = 1;
            this.updateStepDisplay();
            return;
          }

          this.showLoading(true);

          try {
            const response = await fetch("/api/config/update", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                key: document.getElementById("activationKey").value.trim(),
                steam_path: "",
                debug_mode: false,
                logging_files: true,
                show_console: false,
              }),
            });

            const data = await response.json();

            if (data.success) {
              this.showSnackbar("é…ç½®ä¿å­˜æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...", "success");
              setTimeout(() => {
                window.location.href = "/";
              }, 1500);
            } else {
              throw new Error(data.message || "ä¿å­˜é…ç½®å¤±è´¥");
            }
          } catch (error) {
            this.showSnackbar("ä¿å­˜é…ç½®å¤±è´¥ï¼š" + error.message, "error");
            console.error("Save config error:", error);
          } finally {
            this.showLoading(false);
          }
        }

        showLoading(show) {
          const overlay = document.getElementById("loadingOverlay");
          overlay.classList.toggle("show", show);
        }

        showSnackbar(message, type = "info") {
          const snackbar = document.getElementById("snackbar");
          const snackbarMessage = document.getElementById("snackbarMessage");

          snackbarMessage.textContent = message;
          snackbar.className = `snackbar ${type} show`;

          setTimeout(() => {
            this.hideSnackbar();
          }, 4000);
        }

        hideSnackbar() {
          const snackbar = document.getElementById("snackbar");
          snackbar.classList.remove("show");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        new OOBEManager();
      });
    </script>
    <script src="{{ url_for('static', path='js/theme.js') }}"></script>
  </body>
</html>
